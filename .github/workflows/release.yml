# yamllint disable rule:truthy
---
name: release

on:
  release:
    types:
      - 'published'
  workflow_dispatch:
    inputs:
      release_tag:
        description: >-
          Existing release tag to attach assets to (for example, v0.1.0).
        required: true
      archive_version:
        description: >-
          Override archive version (defaults to the tag value without the
          leading v/V prefix).
        required: false

jobs:
  package-and-upload:
    name: Package and publish Concordat Vale
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      UV_CACHE_DIR: .uv-cache
      UV_TOOL_DIR: .uv-tools
    steps:
      - name: Check out repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Install uv
        uses: astral-sh/setup-uv@b49dc9e8821aa6e5df06b85779f66761402a1787

      - name: Resolve release metadata
        id: meta
        env:
          DISPATCH_TAG: ${{ github.event.inputs.release_tag }}
          DISPATCH_VERSION: ${{ github.event.inputs.archive_version }}
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            release_tag="$(
              jq -r '.release.tag_name' "$GITHUB_EVENT_PATH"
            )"
          else
            release_tag="${DISPATCH_TAG:-}"
          fi
          if [[ -z "${release_tag}" || "${release_tag}" == "null" ]]; then
            echo "Release tag is required." >&2
            exit 1
          fi
          archive_version="${DISPATCH_VERSION:-}"
          if [[ -z "${archive_version}" || \
                "${archive_version}" == "null" ]]; then
            archive_version="${release_tag#v}"
            archive_version="${archive_version#V}"
          fi
          if [[ -z "${archive_version}" ]]; then
            echo "Unable to derive archive version." >&2
            exit 1
          fi
          echo "tag=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "version=${archive_version}" >> "$GITHUB_OUTPUT"

      - name: Install project dependencies
        run: uv sync --group dev --frozen

      - name: Package Concordat Vale style
        id: package
        run: |
          set -euo pipefail
          archive_path="$(
            uv run stilyagi zip \
              --archive-version "${{ steps.meta.outputs.version }}" \
              --force
          )"
          echo "path=${archive_path}" >> "$GITHUB_OUTPUT"

      - name: Upload archive to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh release upload \
            "${{ steps.meta.outputs.tag }}" \
            "${{ steps.package.outputs.path }}" \
            --clobber
