# yamllint disable rule:truthy
---
name: release

env:
  STILYAGI_SOURCE: https://github.com/leynos/stilyagi.git@v0.1.0

on:
  release:
    types:
      - 'published'
  workflow_dispatch:
    inputs:
      release_tag:
        description: >-
          Existing release tag to attach assets to (for example, v0.1.0).
        required: true
      archive_version:
        description: >-
          Override archive version (defaults to the tag value without the
          leading v/V prefix).
        required: false

jobs:
  package-and-upload:
    name: Package and publish Concordat Vale
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      UV_CACHE_DIR: .uv-cache
      UV_TOOL_DIR: .uv-tools
      STILYAGI_SOURCE: ${{ env.STILYAGI_SOURCE }}
    steps:
      - name: Check out repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Detect act runtime
        if: ${{ github.actor == 'nektos/act' }}
        run: echo "ACT_CONTEXT=true" >> "$GITHUB_ENV"

      - name: Isolate uv paths when running under act
        if: ${{ env.ACT_CONTEXT == 'true' }}
        run: |
          set -euo pipefail
          TEMP_ROOT="${RUNNER_TEMP:-/tmp}"
          echo "UV_CACHE_DIR=${TEMP_ROOT}/concordat-vale-uv-cache" >> "$GITHUB_ENV"
          echo "UV_TOOL_DIR=${TEMP_ROOT}/concordat-vale-uv-tools" >> "$GITHUB_ENV"
          echo "UV_PROJECT_ENVIRONMENT=${TEMP_ROOT}/concordat-vale-uv-venv" >> "$GITHUB_ENV"

      - name: Expose uv env when running under act
        if: ${{ env.ACT_CONTEXT == 'true' }}
        run: |
          set -euo pipefail
          printf 'UV_ENV %s=%s\n' "UV_CACHE_DIR" "${UV_CACHE_DIR}"
          printf 'UV_ENV %s=%s\n' "UV_TOOL_DIR" "${UV_TOOL_DIR}"
          printf 'UV_ENV %s=%s\n' "UV_PROJECT_ENVIRONMENT" "${UV_PROJECT_ENVIRONMENT}"

      - name: Install uv (act fallback)
        if: ${{ env.ACT_CONTEXT == 'true' }}
        env:
          UV_BIN_DIR: ${{ github.workspace }}/.uv-bin
        run: |
          set -euo pipefail
          mkdir -p "${UV_BIN_DIR}"
          export XDG_BIN_HOME="${UV_BIN_DIR}"
          curl -LsSf https://astral.sh/uv/install.sh \
            | sh -s -- --no-modify-path
          for source_dir in \
            "${UV_BIN_DIR}" "$HOME/.local/bin" "/root/.local/bin"; do
            if [[ -x "${source_dir}/uv" && -x "${source_dir}/uvx" ]]; then
              if [[ "${source_dir}" != "${UV_BIN_DIR}" ]]; then
                cp "${source_dir}/uv" "${UV_BIN_DIR}/uv"
                cp "${source_dir}/uvx" "${UV_BIN_DIR}/uvx"
              fi
              break
            fi
          done
          echo "${UV_BIN_DIR}" >> "$GITHUB_PATH"

      - name: Install uv
        if: ${{ env.ACT_CONTEXT != 'true' }}
        uses: astral-sh/setup-uv@b49dc9e8821aa6e5df06b85779f66761402a1787

      - name: Resolve release metadata
        id: meta
        env:
          DISPATCH_TAG: ${{ github.event.inputs.release_tag }}
          DISPATCH_VERSION: ${{ github.event.inputs.archive_version }}
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            release_tag="$(
              jq -r '.release.tag_name' "$GITHUB_EVENT_PATH"
            )"
          else
            release_tag="${DISPATCH_TAG:-}"
          fi
          if [[ -z "${release_tag}" || "${release_tag}" == "null" ]]; then
            echo "Release tag is required." >&2
            exit 1
          fi
          archive_version="${DISPATCH_VERSION:-}"
          if [[ -z "${archive_version}" || \
                "${archive_version}" == "null" ]]; then
            archive_version="${release_tag#v}"
            archive_version="${archive_version#V}"
          fi
          if [[ -z "${archive_version}" ]]; then
            echo "Unable to derive archive version." >&2
            exit 1
          fi
          echo "tag=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "version=${archive_version}" >> "$GITHUB_OUTPUT"

      - name: Install project dependencies
        run: uv sync --group dev --frozen

      - name: Package Concordat Vale style
        id: package
        run: |
          set -euo pipefail
          archive_path="$(
            uvx --from "${STILYAGI_SOURCE}" stilyagi zip \
              --archive-version "${{ steps.meta.outputs.version }}" \
              --force
          )"
          echo "path=${archive_path}" >> "$GITHUB_OUTPUT"

      - name: Upload archive to release
        if: ${{ env.ACT != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh release upload \
            "${{ steps.meta.outputs.tag }}" \
            "${{ steps.package.outputs.path }}" \
            --clobber
